# Hey, emacs! This is a -*- shell-script -*-

# Size of loopback files to create, in MB (if loopback files are used)
DISK_SIZE=1000000

CONTROL_FILE=/dev/castle-fs/control

function kernel_fs_running {
    [ -e "/dev/castle-fs/control" ] || lsmod | grep -q '^castle_fs$'
}

function init_kernel_fs {
    if ! kernel_fs_running; then
        echo "Castle FS kernel module not found, trying to insert."
        modprobe castle-fs
        # Wait up to 5 seconds for the control file to appear
        # udev renaming is sometimes slow
        for i in `seq 50`; do
            if [ -e "${CONTROL_FILE}" ]; then
                break
            fi
            # Wait 0.1s
            usleep 100000
        done
        if [ ! -e "${CONTROL_FILE}" ]; then
            echo "Control file has not been created after kernel module insertion"
            exit 1
        fi
    fi
}

function unmount_kernel_fs {
    if kernel_fs_running; then 
        echo "Unmounting Kernel FS..."

        rmmod castle_fs
        
        # Wait up to 5 seconds for the control file to disappear
        for i in `seq 50`; do
            if [ ! -e ${CONTROL_FILE} ]; then
                break
            fi
                # Wait 0.1s
            usleep 100000
        done
        if [ -e ${CONTROL_FILE} ]; then
            echo "Removed castle_fs module, but the control file is still there!"
            exit 1
        fi
    fi
}

function devid_of_disk {
    local disk="$1"
    major=$(stat -c '%t' "$disk")
    minor=$(stat -c '%T' "$disk")
    devid=$(( (0x$minor & 0xFF) | ( (0x$minor & 0xFFF00) << 12 ) | (0x$major << 8) ))
    printf '0x%x' "$devid"
}

function load_fs_and_claim {
    declare -a devids=() loops=()

    for disk in "$@"
    do
      if [ -e "$disk" ] && [ -b "$disk" ]
          then
          # Block special
          devids=("${devids[@]}" $(devid_of_disk "$disk"))
          continue
      fi

      if ! [ -e "$disk" ]
      then
          if echo $disk | grep -q '^/dev/'
          then
          # Presumably block special device (not existing)
              echo "Device $disk does not exist, aborting"
              exit 1
          fi

          # Loopback file (not existing)
          mkdir -p $(dirname "$disk")
          dd conv=excl if=/dev/zero of=$disk bs=1M count=1 seek=$DISK_SIZE 2>/dev/null
      fi

      if [ -e "$disk" ] && [ -f "$disk" ]
      then
          # Loopback file (existing)
          loops=("${loops[@]}" "$disk")
      fi
    done

    for disk in "${loops[@]}"
    do
      loop=$(losetup -f)
      losetup "$loop" "$disk"
      devids=("${devids[@]}" $(devid_of_disk "$loop"))
    done

    init_kernel_fs

    for devid in "${devids[@]}"
    do
      castle-cli claim "$devid" > /dev/null
    done
}
